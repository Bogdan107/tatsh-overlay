From b1f965a0dbb3a4734e18c3798beeb856947c37a8 Mon Sep 17 00:00:00 2001
From: Andrew Udvare <audvare@gmail.com>
Date: Fri, 11 Jan 2019 06:23:06 -0500
Subject: [PATCH 1/4] build system: install binaries to CMAKE_INSTALL_BINDIR

---
 src/decaf-cli/CMakeLists.txt         | 4 +++-
 src/decaf-qt/CMakeLists.txt          | 4 +++-
 src/decaf-sdl/CMakeLists.txt         | 4 +++-
 tools/gfd-tool/CMakeLists.txt        | 4 +++-
 tools/latte-assembler/CMakeLists.txt | 4 +++-
 tools/pm4-replay-qt/CMakeLists.txt   | 4 +++-
 tools/pm4-replay/CMakeLists.txt      | 4 +++-
 7 files changed, 21 insertions(+), 7 deletions(-)

diff --git a/src/decaf-cli/CMakeLists.txt b/src/decaf-cli/CMakeLists.txt
index 06d968ad6..a8694e1b5 100644
--- a/src/decaf-cli/CMakeLists.txt
+++ b/src/decaf-cli/CMakeLists.txt
@@ -1,3 +1,5 @@
+include(GNUInstallDirs)
+
 project(decaf-cli)
 
 include_directories(".")
@@ -14,4 +16,4 @@ target_link_libraries(decaf-cli
     cpptoml
     excmd)
 
-install(TARGETS decaf-cli RUNTIME DESTINATION "${CMAKE_INSTALL_PREFIX}")
+install(TARGETS decaf-cli RUNTIME DESTINATION "${CMAKE_INSTALL_BINDIR}")
diff --git a/src/decaf-qt/CMakeLists.txt b/src/decaf-qt/CMakeLists.txt
index 26011ea5c..2f5fea35c 100644
--- a/src/decaf-qt/CMakeLists.txt
+++ b/src/decaf-qt/CMakeLists.txt
@@ -1,3 +1,5 @@
+include(GNUInstallDirs)
+
 project(decaf-qt)
 set(CMAKE_AUTOMOC ON)
 set(CMAKE_INCLUDE_CURRENT_DIR ON)
@@ -78,4 +80,4 @@ if(MSVC)
            $<TARGET_FILE_DIR:decaf-qt>)
 endif()
 
-install(TARGETS decaf-qt RUNTIME DESTINATION "${CMAKE_INSTALL_PREFIX}")
+install(TARGETS decaf-qt RUNTIME DESTINATION "${CMAKE_INSTALL_BINDIR}")
diff --git a/src/decaf-sdl/CMakeLists.txt b/src/decaf-sdl/CMakeLists.txt
index 132727249..d47a7da7f 100644
--- a/src/decaf-sdl/CMakeLists.txt
+++ b/src/decaf-sdl/CMakeLists.txt
@@ -1,3 +1,5 @@
+include(GNUInstallDirs)
+
 project(decaf-sdl)
 
 include_directories(".")
@@ -39,4 +41,4 @@ if(MSVC)
         LINK_FLAGS "/SUBSYSTEM:WINDOWS")
 endif()
 
-install(TARGETS decaf-sdl RUNTIME DESTINATION "${CMAKE_INSTALL_PREFIX}")
+install(TARGETS decaf-sdl RUNTIME DESTINATION "${CMAKE_INSTALL_BINDIR}")
diff --git a/tools/gfd-tool/CMakeLists.txt b/tools/gfd-tool/CMakeLists.txt
index 15b28e849..9326bd97e 100644
--- a/tools/gfd-tool/CMakeLists.txt
+++ b/tools/gfd-tool/CMakeLists.txt
@@ -1,3 +1,5 @@
+include(GNUInstallDirs)
+
 project(gfd-tool)
 
 include_directories(".")
@@ -15,4 +17,4 @@ target_link_libraries(gfd-tool
     libgfd
     excmd)
 
-install(TARGETS gfd-tool RUNTIME DESTINATION "${CMAKE_INSTALL_PREFIX}")
+install(TARGETS gfd-tool RUNTIME DESTINATION "${CMAKE_INSTALL_BINDIR}")
diff --git a/tools/latte-assembler/CMakeLists.txt b/tools/latte-assembler/CMakeLists.txt
index 75a2a03f9..94797df9f 100644
--- a/tools/latte-assembler/CMakeLists.txt
+++ b/tools/latte-assembler/CMakeLists.txt
@@ -1,3 +1,5 @@
+include(GNUInstallDirs)
+
 project(latte-assembler)
 
 include_directories(".")
@@ -37,4 +39,4 @@ set_target_properties(latte-assembler PROPERTIES FOLDER tools)
 GroupSources(src)
 GroupSources(resources)
 
-install(TARGETS latte-assembler RUNTIME DESTINATION "${CMAKE_INSTALL_PREFIX}")
+install(TARGETS latte-assembler RUNTIME DESTINATION "${CMAKE_INSTALL_BINDIR}")
diff --git a/tools/pm4-replay-qt/CMakeLists.txt b/tools/pm4-replay-qt/CMakeLists.txt
index cef732b2e..a354755cd 100644
--- a/tools/pm4-replay-qt/CMakeLists.txt
+++ b/tools/pm4-replay-qt/CMakeLists.txt
@@ -1,3 +1,5 @@
+include(GNUInstallDirs)
+
 project(pm4-replay-qt)
 set(CMAKE_AUTOMOC ON)
 set(CMAKE_INCLUDE_CURRENT_DIR ON)
@@ -23,4 +25,4 @@ target_link_libraries(pm4-replay-qt
 
 target_link_libraries(pm4-replay-qt Qt5::Widgets)
 
-install(TARGETS pm4-replay-qt RUNTIME DESTINATION "${CMAKE_INSTALL_PREFIX}")
+install(TARGETS pm4-replay-qt RUNTIME DESTINATION "${CMAKE_INSTALL_BINDIR}")
diff --git a/tools/pm4-replay/CMakeLists.txt b/tools/pm4-replay/CMakeLists.txt
index 3661aedcc..91f22ff2a 100644
--- a/tools/pm4-replay/CMakeLists.txt
+++ b/tools/pm4-replay/CMakeLists.txt
@@ -1,3 +1,5 @@
+include(GNUInstallDirs)
+
 project(pm4-replay)
 
 include_directories(".")
@@ -26,4 +28,4 @@ if(${CMAKE_SYSTEM_NAME} MATCHES "Linux")
     target_link_libraries(pm4-replay X11)
 endif()
 
-install(TARGETS pm4-replay RUNTIME DESTINATION "${CMAKE_INSTALL_PREFIX}")
+install(TARGETS pm4-replay RUNTIME DESTINATION "${CMAKE_INSTALL_BINDIR}")

From 15bd6e34263eb63ae1016faf396502b85c27657b Mon Sep 17 00:00:00 2001
From: Andrew Udvare <audvare@gmail.com>
Date: Fri, 11 Jan 2019 06:24:02 -0500
Subject: [PATCH 2/4] decaf-qt: Allow building without SDL

---
 src/decaf-qt/CMakeLists.txt | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/decaf-qt/CMakeLists.txt b/src/decaf-qt/CMakeLists.txt
index 2f5fea35c..242348ae5 100644
--- a/src/decaf-qt/CMakeLists.txt
+++ b/src/decaf-qt/CMakeLists.txt
@@ -35,9 +35,11 @@ GroupSources(ui)
 target_include_directories(decaf-qt PRIVATE
    ${SDL2_INCLUDE_DIRS})
 
+target_link_libraries(decaf-qt common)
+if(DECAF_SDL)
+    target_link_libraries(decaf-qt common-sdl)
+endif()
 target_link_libraries(decaf-qt
-   common
-   common-sdl
    libconfig
    libcpu
    libdebugui

From e7418fd7e4a83bab44cf97bb9673676548719016 Mon Sep 17 00:00:00 2001
From: Andrew Udvare <audvare@gmail.com>
Date: Fri, 11 Jan 2019 06:24:39 -0500
Subject: [PATCH 3/4] build system: install resources and docs to normal
 directories

---
 resources/CMakeLists.txt | 24 +++++++++++++++++++-----
 1 file changed, 19 insertions(+), 5 deletions(-)

diff --git a/resources/CMakeLists.txt b/resources/CMakeLists.txt
index a507e6b57..f18831ad3 100644
--- a/resources/CMakeLists.txt
+++ b/resources/CMakeLists.txt
@@ -1,3 +1,5 @@
+include(GNUInstallDirs)
+
 project(resources)
 
 set(Fonts
@@ -5,9 +7,13 @@ set(Fonts
    fonts/CafeKr.ttf
    fonts/CafeStd.ttf
    fonts/CafeTw.ttf
-   fonts/NotoSansCJK.LICENSE
-   fonts/DejaVuSansMono.ttf
-   fonts/DejaVuSansMono.LICENSE)
+   fonts/DejaVuSansMono.ttf)
+set(Docs
+    fonts/DejaVuSansMono.LICENSE
+    fonts/NotoSansCJK.LICENSE
+    ../README.md
+    ../LICENSE.md)
+set(PARENT_PROJECT_NAME decaf-emu)
 
 set(ResourceFiles ${Fonts})
 
@@ -20,5 +26,13 @@ foreach(ResourceFile ${ResourceFiles})
                           $<TARGET_FILE_DIR:libdecaf>/resources/${ResourceFile})
 endforeach()
 
-install(FILES ${Fonts}
-        DESTINATION "${CMAKE_INSTALL_PREFIX}/resources/fonts")
+if(DECAF_RESOURCES_PATH)
+  install(FILES ${Fonts} DESTINATION "${DECAF_RESOURCES_PATH}")
+else()
+  install(FILES ${Fonts}
+          DESTINATION "${CMAKE_INSTALL_DATAROOTDIR}/${PARENT_PROJECT_NAME}/resources/fonts")
+endif()
+
+if(DECAF_DOCS)
+  install(FILES ${Docs} DESTINATION "${CMAKE_INSTALL_DATAROOTDIR}/doc/${PARENT_PROJECT_NAME}")
+endif()

From 0305d54fbd3052e2a73837303046cc0c5006e179 Mon Sep 17 00:00:00 2001
From: Andrew Udvare <audvare@gmail.com>
Date: Fri, 11 Jan 2019 06:25:04 -0500
Subject: [PATCH 4/4] libdecaf: Allow setting a default resources path
 (DECAF_RESOURCES_PATH) during compilation

---
 src/libdecaf/CMakeLists.txt | 5 +++++
 src/libdecaf/decaf_config.h | 4 ++++
 2 files changed, 9 insertions(+)

diff --git a/src/libdecaf/CMakeLists.txt b/src/libdecaf/CMakeLists.txt
index 6fbfa7a36..2d0f9c27a 100644
--- a/src/libdecaf/CMakeLists.txt
+++ b/src/libdecaf/CMakeLists.txt
@@ -9,6 +9,11 @@ file(GLOB_RECURSE HEADER_FILES *.h)
 add_library(libdecaf STATIC ${SOURCE_FILES} ${HEADER_FILES})
 GroupSources(src)
 
+if(DECAF_RESOURCES_PATH)
+    set_property(TARGET libdecaf APPEND PROPERTY
+        COMPILE_DEFINITIONS DECAF_RESOURCES_PATH="${DECAF_RESOURCES_PATH}")
+endif()
+
 target_include_directories(libdecaf PRIVATE
     ${CURL_INCLUDE_DIRS})
 
diff --git a/src/libdecaf/decaf_config.h b/src/libdecaf/decaf_config.h
index a90c704ac..dc23a71d5 100644
--- a/src/libdecaf/decaf_config.h
+++ b/src/libdecaf/decaf_config.h
@@ -68,7 +68,11 @@ struct SystemSettings
    std::string sdcard_path = "sdcard";
    std::string hfio_path = "";
    std::string content_path = {};
+#ifndef DECAF_RESOURCES_PATH
    std::string resources_path = "resources";
+#else
+   std::string resources_path = DECAF_RESOURCES_PATH;
+#endif
    bool time_scale_enabled = false;
    double time_scale = 1.0;
    std::vector<std::string> lle_modules;
